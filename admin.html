<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/datepicker.min.js"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <i class="fas fa-spa"></i> Гармония
            </a>
            <ul class="nav-links">
                <li><a href="index.html"><i class="fas fa-home"></i> Главная</a></li>
                <li><a href="admin.html" class="active"><i class="fas fa-cog"></i> Админ</a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Выйти</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <h1 class="pink-text text-center mb-3">Админ-панель</h1>
            
            <div class="admin-grid">
                <div class="card">
                    <h2 class="pink-text mb-2"><i class="fas fa-concierge-bell"></i> Услуги</h2>
                    <button class="btn mb-1 full-width-btn" onclick="showAddServiceForm()">Добавить услугу</button>
                    <div class="table-container">
                        <table id="servicesTable">
                            <thead>
                                <tr>
                                    <th>Название</th>
                                    <th>Цена</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="servicesList">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="pink-text mb-2"><i class="fas fa-user-tie"></i> Мастера</h2>
                    <button class="btn mb-1 full-width-btn" onclick="showAddMasterForm()">Добавить мастера</button>
                    <div class="table-container">
                        <table id="mastersTable">
                            <thead>
                                <tr>
                                    <th>Имя</th>
                                    <th>Специализация</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="mastersList">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="pink-text mb-2"><i class="fas fa-calendar-alt"></i> Записи</h2>
                    <button class="btn mb-1 full-width-btn" onclick="showAddAppointmentForm()">Добавить запись</button>
                    <div class="table-container">
                        <table id="appointmentsTable">
                            <thead>
                                <tr>
                                    <th>Клиент</th>
                                    <th>Услуга</th>
                                    <th>Мастер</th>
                                    <th>Дата</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="appointmentsList">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <h2 class="pink-text mb-2"><i class="fas fa-users"></i> Клиенты</h2>
                    <button class="btn mb-1 full-width-btn" onclick="showAddClientForm()">Добавить клиента</button>
                    <div class="table-container">
                        <table id="clientsTable">
                            <thead>
                                <tr>
                                    <th>Имя</th>
                                    <th>Email</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="clientsList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modalOverlay" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Добавить услугу</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalContent">
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Салон красоты "Гармония". Админ-панель</p>
        </div>
    </footer>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBkntHcR8prtCSc5yW7fu3zsIOxu4Vl41o",
            authDomain: "salon-69bf0.firebaseapp.com",
            projectId: "salon-69bf0",
            storageBucket: "salon-69bf0.firebasestorage.app",
            messagingSenderId: "640329978062",
            appId: "1:640329978062:web:f9f7647f2642fd3c6f809f",
            measurementId: "G-X9VT54W2NQ"
        };

        // Инициализация Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Проверка авторизации
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'auth.html';
                return;
            }
            loadServices();
            loadMasters();
            loadAppointments();
            loadClients();
        });

        // Выход
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        });

        // Загрузка услуг
        async function loadServices() {
            try {
                const snapshot = await db.collection('services').where('isActive', '==', true).get();
                const servicesList = document.getElementById('servicesList');
                servicesList.innerHTML = '';
                
                if (snapshot.empty) {
                    servicesList.innerHTML = '<tr><td colspan="3">Нет услуг</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const service = doc.data();
                    servicesList.innerHTML += `
                        <tr>
                            <td>${service.name || 'Без названия'}</td>
                            <td>${service.price || '0'} ₽</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="editService('${doc.id}', '${service.name || ''}', '${service.price || ''}')">Редактировать</button>
                                <button class="btn btn-secondary btn-sm" onclick="deleteService('${doc.id}')">Удалить</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Ошибка загрузки услуг:", error);
                document.getElementById('servicesList').innerHTML = '<tr><td colspan="3">Ошибка загрузки</td></tr>';
            }
        }

        // Загрузка мастеров
        async function loadMasters() {
            try {
                const snapshot = await db.collection('masters').where('isActive', '==', true).get();
                const mastersList = document.getElementById('mastersList');
                mastersList.innerHTML = '';
                
                if (snapshot.empty) {
                    mastersList.innerHTML = '<tr><td colspan="3">Нет мастеров</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const master = doc.data();
                    mastersList.innerHTML += `
                        <tr>
                            <td>${master.name || 'Без имени'}</td>
                            <td>${master.specialization || 'Не указана'}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="editMaster('${doc.id}', '${master.name || ''}', '${master.specialization || ''}')">Редактировать</button>
                                <button class="btn btn-secondary btn-sm" onclick="deleteMaster('${doc.id}')">Удалить</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Ошибка загрузки мастеров:", error);
                document.getElementById('mastersList').innerHTML = '<tr><td colspan="3">Ошибка загрузки</td></tr>';
            }
        }

        // Загрузка записей
       async function loadAppointments() {
        try {
            const snapshot = await db.collection('appointments').get();
            const appointmentsList = document.getElementById('appointmentsList');
            appointmentsList.innerHTML = '';
        
        if (snapshot.empty) {
            appointmentsList.innerHTML = '<tr><td colspan="6">Нет записей</td></tr>';
            return;
        }
        
        for (const doc of snapshot.docs) {
            const appointment = doc.data();
            
            let clientName = "Не указан";
            if (appointment.client) {
                try {
                    const clientDoc = await db.collection('users').doc(appointment.client).get();
                    if (clientDoc.exists) {
                        clientName = clientDoc.data().name || "Не указан";
                    }
                } catch (error) {
                    console.error("Ошибка загрузки клиента:", error);
                }
            }

            let serviceName = "Не указана";
            if (appointment.service) {
                try {
                    const serviceDoc = await db.collection('services').doc(appointment.service).get();
                    if (serviceDoc.exists) {
                        serviceName = serviceDoc.data().name || "Не указана";
                    }
                } catch (error) {
                    console.error("Ошибка загрузки услуги:", error);
                }
            }
            
            let masterName = "Не указан";
            if (appointment.master) {
                try {
                    const masterDoc = await db.collection('masters').doc(appointment.master).get();
                    if (masterDoc.exists) {
                        masterName = masterDoc.data().name || "Не указан";
                    }
                } catch (error) {
                    console.error("Ошибка загрузки мастера:", error);
                }
            }
            
            let dateString = "Не указана";
            if (appointment.date) {
                try {
                    const date = appointment.date.toDate();
                    dateString = date.toLocaleString("ru-RU");
                } catch (error) {
                    dateString = "Ошибка даты";
                }
            }

            appointmentsList.innerHTML += `
                <tr>
                    <td>${clientName}</td>
                    <td>${serviceName}</td>
                    <td>${masterName}</td>
                    <td>${dateString}</td>
                    <td>Подтверждена</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editAppointment('${doc.id}', '${appointment.client || ''}', '${appointment.service || ''}', '${appointment.master || ''}', '${appointment.date ? appointment.date.toDate().toISOString().slice(0, 16) : ''}')">Редактировать</button>
                        <button class="btn btn-secondary btn-sm" onclick="deleteAppointment('${doc.id}')">Удалить</button>
                    </td>
                </tr>
                `;
                }
            } catch (error) {
            console.error("Ошибка загрузки записей:", error);
            document.getElementById('appointmentsList').innerHTML = '<tr><td colspan="5">Ошибка загрузки</td></tr>';
            }
        }
        // Загрузка клиентов
        async function loadClients() {
            try {
                const snapshot = await db.collection('users').where('role', '==', 'client').get();
                const clientsList = document.getElementById('clientsList');
                clientsList.innerHTML = '';
                
                if (snapshot.empty) {
                    clientsList.innerHTML = '<tr><td colspan="3">Нет клиентов</td></tr>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const client = doc.data();
                    clientsList.innerHTML += `
                        <tr>
                            <td>${client.name || 'Без имени'}</td>
                            <td>${client.email || 'Не указан'}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewClientDetails('${doc.id}')">Просмотр</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error("Ошибка загрузки клиентов:", error);
                document.getElementById('clientsList').innerHTML = '<tr><td colspan="3">Ошибка загрузки</td></tr>';
            }
        }

        function showAddServiceForm() {
            document.getElementById('modalTitle').textContent = 'Добавить услугу';
            document.getElementById('modalContent').innerHTML = `
                <form onsubmit="addService(event)">
                    <div class="form-group">
                        <label>Название услуги:</label>
                        <input type="text" id="serviceName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Цена (₽):</label>
                        <input type="number" id="servicePrice" class="form-control" required>
                    </div>
                    <button type="submit" class="btn full-width-btn">Добавить</button>
                </form>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        async function addService(event) {
            event.preventDefault();
            
            const service = {
                name: document.getElementById('serviceName').value,
                price: parseInt(document.getElementById('servicePrice').value),
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('services').add(service);
                alert('Услуга добавлена!');
                closeModal();
                loadServices();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        function showAddMasterForm() {
            document.getElementById('modalTitle').textContent = 'Добавить мастера';
            document.getElementById('modalContent').innerHTML = `
                <form onsubmit="addMaster(event)">
                    <div class="form-group">
                        <label>Имя мастера:</label>
                        <input type="text" id="masterName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Специализация:</label>
                        <input type="text" id="masterSpecialization" class="form-control" required>
                    </div>
                    <button type="submit" class="btn full-width-btn">Добавить</button>
                </form>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        async function addMaster(event) {
            event.preventDefault();
            
            const master = {
                name: document.getElementById('masterName').value,
                specialization: document.getElementById('masterSpecialization').value,
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('masters').add(master);
                alert('Мастер добавлен!');
                closeModal();
                loadMasters();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('modalContent').innerHTML = '';
        }

        // Удаление услуг
        async function deleteService(serviceId) {
            if (confirm('Вы уверены, что хотите удалить эту услугу?')) {
                try {
                    await db.collection('services').doc(serviceId).update({
                        isActive: false
                    });
                    alert('Услуга удалена');
                    loadServices();
                } catch (error) {
                    alert('Ошибка удаления: ' + error.message);
                }
            }
        }

        // Удаление мастеров
        async function deleteMaster(masterId) {
            if (confirm('Вы уверены, что хотите удалить этого мастера?')) {
                try {
                    await db.collection('masters').doc(masterId).update({
                        isActive: false
                    });
                    alert('Мастер удален');
                    loadMasters();
                } catch (error) {
                    alert('Ошибка удаления: ' + error.message);
                }
            }
        }

        // Удаление записей
        async function deleteAppointment(appointmentId) {
            if (confirm('Вы уверены, что хотите удалить эту запись?')) {
                try {
                    await db.collection('appointments').doc(appointmentId).delete();
                    alert('Запись удалена');
                    loadAppointments();
                } catch (error) {
                    alert('Ошибка удаления: ' + error.message);
                }
            }
        }

        // Редактирование услуги
        function editService(serviceId, currentName, currentPrice) {
            document.getElementById('modalTitle').textContent = 'Редактировать услугу';
            document.getElementById('modalContent').innerHTML = `
                <form onsubmit="updateService(event, '${serviceId}')">
                    <div class="form-group">
                        <label>Название услуги:</label>
                        <input type="text" id="editServiceName" class="form-control" value="${currentName}" required>
                    </div>
                    <div class="form-group">
                        <label>Цена (₽):</label>
                        <input type="number" id="editServicePrice" class="form-control" value="${currentPrice}" required>
                    </div>
                    <button type="submit" class="btn full-width-btn">Сохранить</button>
                </form>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        async function updateService(event, serviceId) {
            event.preventDefault();

            const updatedService = {
                name: document.getElementById('editServiceName').value,
                price: parseInt(document.getElementById('editServicePrice').value),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('services').doc(serviceId).update(updatedService);
                alert('Услуга обновлена!');
                closeModal();
                loadServices();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        // Редактирование мастера
        function editMaster(masterId, currentName, currentSpecialization) {
            document.getElementById('modalTitle').textContent = 'Редактировать мастера';
            document.getElementById('modalContent').innerHTML = `
                <form onsubmit="updateMaster(event, '${masterId}')">
                    <div class="form-group">
                        <label>Имя мастера:</label>
                        <input type="text" id="editMasterName" class="form-control" value="${currentName}" required>
                    </div>
                    <div class="form-group">
                        <label>Специализация:</label>
                        <input type="text" id="editMasterSpecialization" class="form-control" value="${currentSpecialization}" required>
                    </div>
                    <button type="submit" class="btn full-width-btn">Сохранить</button>
                </form>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        async function updateMaster(event, masterId) {
            event.preventDefault();

            const updatedMaster = {
                name: document.getElementById('editMasterName').value,
                specialization: document.getElementById('editMasterSpecialization').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('masters').doc(masterId).update(updatedMaster);
                alert('Мастер обновлен!');
                closeModal();
                loadMasters();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        // Просмотр клиента
        function viewClientDetails(clientId) {
            alert('Просмотр клиента с ID: ' + clientId + '\n\nВ реальном проекте здесь будет детальная информация.');
        }

        // Функции для записей
        function showAddAppointmentForm() {
            document.getElementById('modalTitle').textContent = 'Добавить запись';
            document.getElementById('modalContent').innerHTML = `
                <form onsubmit="addAppointment(event)">
                    <div class="form-group">
                        <label>Клиент:</label>
                        <select id="appointmentClient" class="form-control" required>
                            <option value="">Выберите клиента</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Услуга:</label>
                        <select id="appointmentService" class="form-control" required>
                            <option value="">Выберите услугу</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Мастер:</label>
                        <select id="appointmentMaster" class="form-control" required>
                            <option value="">Выберите мастера</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Дата и время:</label>
                        <input type="datetime-local" id="appointmentDate" class="form-control" required>
                    </div>
                    <button type="submit" class="btn full-width-btn">Добавить</button>
                </form>
            `;
            loadClientsForSelect();
            loadServicesForSelect();
            loadMastersForSelect();
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        async function loadClientsForSelect() {
            try {
                const snapshot = await db.collection('users').where('role', '==', 'client').get();
                const select = document.getElementById('appointmentClient');
                select.innerHTML = '<option value="">Выберите клиента</option>';
                snapshot.forEach(doc => {
                    const client = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${client.name || 'Без имени'}</option>`;
                });
            } catch (error) {
                console.error("Ошибка загрузки клиентов:", error);
            }
        }

        async function loadServicesForSelect() {
            try {
                const snapshot = await db.collection('services').where('isActive', '==', true).get();
                const select = document.getElementById('appointmentService');
                select.innerHTML = '<option value="">Выберите услугу</option>';
                snapshot.forEach(doc => {
                    const service = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${service.name || 'Без названия'}</option>`;
                });
            } catch (error) {
                console.error("Ошибка загрузки услуг:", error);
            }
        }

        async function loadMastersForSelect() {
            try {
                const snapshot = await db.collection('masters').where('isActive', '==', true).get();
                const select = document.getElementById('appointmentMaster');
                select.innerHTML = '<option value="">Выберите мастера</option>';
                snapshot.forEach(doc => {
                    const master = doc.data();
                    select.innerHTML += `<option value="${doc.id}">${master.name || 'Без имени'}</option>`;
                });
            } catch (error) {
                console.error("Ошибка загрузки мастеров:", error);
            }
        }

        async function addAppointment(event) {
            event.preventDefault();

            const appointment = {
                client: document.getElementById('appointmentClient').value,
                service: document.getElementById('appointmentService').value,
                master: document.getElementById('appointmentMaster').value,
                date: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('appointmentDate').value)),
                status: 'confirmed',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('appointments').add(appointment);
                alert('Запись добавлена!');
                closeModal();
                loadAppointments();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        function editAppointment(appointmentId, clientId, serviceId, masterId, dateTime) {
            document.getElementById('modalTitle').textContent = 'Редактировать запись';
            document.getElementById('modalContent').innerHTML = `
                <form onsubmit="updateAppointment(event, '${appointmentId}')">
                    <div class="form-group">
                        <label>Клиент:</label>
                        <select id="editAppointmentClient" class="form-control" required>
                            <option value="">Выберите клиента</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Услуга:</label>
                        <select id="editAppointmentService" class="form-control" required>
                            <option value="">Выберите услугу</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Мастер:</label>
                        <select id="editAppointmentMaster" class="form-control" required>
                            <option value="">Выберите мастера</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Дата и время:</label>
                        <input type="datetime-local" id="editAppointmentDate" class="form-control" value="${dateTime}" required>
                    </div>
                    <button type="submit" class="btn full-width-btn">Сохранить</button>
                </form>
            `;
            loadClientsForSelectEdit(clientId);
            loadServicesForSelectEdit(serviceId);
            loadMastersForSelectEdit(masterId);
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        async function loadClientsForSelectEdit(selectedClientId) {
            try {
                const snapshot = await db.collection('users').where('role', '==', 'client').get();
                const select = document.getElementById('editAppointmentClient');
                select.innerHTML = '<option value="">Выберите клиента</option>';
                snapshot.forEach(doc => {
                    const client = doc.data();
                    const selected = doc.id === selectedClientId ? 'selected' : '';
                    select.innerHTML += `<option value="${doc.id}" ${selected}>${client.name || 'Без имени'}</option>`;
                });
            } catch (error) {
                console.error("Ошибка загрузки клиентов:", error);
            }
        }

        async function loadServicesForSelectEdit(selectedServiceId) {
            try {
                const snapshot = await db.collection('services').where('isActive', '==', true).get();
                const select = document.getElementById('editAppointmentService');
                select.innerHTML = '<option value="">Выберите услугу</option>';
                snapshot.forEach(doc => {
                    const service = doc.data();
                    const selected = doc.id === selectedServiceId ? 'selected' : '';
                    select.innerHTML += `<option value="${doc.id}" ${selected}>${service.name || 'Без названия'}</option>`;
                });
            } catch (error) {
                console.error("Ошибка загрузки услуг:", error);
            }
        }

        async function loadMastersForSelectEdit(selectedMasterId) {
            try {
                const snapshot = await db.collection('masters').where('isActive', '==', true).get();
                const select = document.getElementById('editAppointmentMaster');
                select.innerHTML = '<option value="">Выберите мастера</option>';
                snapshot.forEach(doc => {
                    const master = doc.data();
                    const selected = doc.id === selectedMasterId ? 'selected' : '';
                    select.innerHTML += `<option value="${doc.id}" ${selected}>${master.name || 'Без имени'}</option>`;
                });
            } catch (error) {
                console.error("Ошибка загрузки мастеров:", error);
            }
        }

        async function updateAppointment(event, appointmentId) {
            event.preventDefault();

            const updatedAppointment = {
                client: document.getElementById('editAppointmentClient').value,
                service: document.getElementById('editAppointmentService').value,
                master: document.getElementById('editAppointmentMaster').value,
                date: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('editAppointmentDate').value)),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('appointments').doc(appointmentId).update(updatedAppointment);
                alert('Запись обновлена!');
                closeModal();
                loadAppointments();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        // Функции для клиентов
        function showAddClientForm() {
            document.getElementById('modalTitle').textContent = 'Добавить клиента';
            document.getElementById('modalContent').innerHTML = `
                <form onsubmit="addClient(event)">
                    <div class="form-group">
                        <label>Имя клиента:</label>
                        <input type="text" id="clientName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="clientEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Пароль:</label>
                        <input type="password" id="clientPassword" class="form-control" required>
                    </div>
                    <button type="submit" class="btn full-width-btn">Добавить</button>
                </form>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        async function addClient(event) {
            event.preventDefault();

            const clientData = {
                name: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                role: 'client',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const password = document.getElementById('clientPassword').value;

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(clientData.email, password);
                const userId = userCredential.user.uid;

                // Добавляем данные пользователя в Firestore
                await db.collection('users').doc(userId).set(clientData);

                alert('Клиент добавлен!');
                closeModal();
                loadClients();
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
    </script>

    <style>
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.5rem;
            border: 1px solid #f0f0f0;
            text-align: left;
        }
        
        th {
            background-color: #fce7f3;
            color: #831843;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.9rem;
        }
    </style>
</body>
</html>